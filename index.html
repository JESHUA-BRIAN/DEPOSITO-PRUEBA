<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Gestión de Stock</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      margin: 0; padding: 30px 15px;
      display: flex; justify-content: center;
    }
    main {
      max-width: 480px; background: white;
      padding: 30px; border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      width: 100%;
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #2c3e50;
    }
    label {
      display: block;
      margin: 12px 0 6px;
      font-weight: 600;
    }
    input[type="text"], input[type="number"] {
      width: 100%; padding: 12px;
      font-size: 1rem;
      border: 2px solid #ccd6f6;
      border-radius: 8px;
    }
    button {
      width: 100%; padding: 14px;
      background: #2e86de; color: white;
      border: none; border-radius: 10px;
      font-weight: 700; font-size: 1rem;
      margin-top: 20px; cursor: pointer;
    }
    button:hover { background: #1b4f72; }
    #scannerControls {
      display: flex; gap: 10px; margin-top: 20px;
    }
    #startScan, #stopScan {
      flex: 1; padding: 10px; border-radius: 10px;
      font-weight: bold; border: none;
    }
    #startScan { background: #27ae60; color: white; }
    #stopScan { background: #e74c3c; color: white; display: none; }
    #reader {
      margin-top: 20px; display: none;
      border-radius: 12px; overflow: hidden;
    }
    #stockList {
      margin-top: 30px;
      list-style: none; padding: 0;
    }
    #stockList li {
      background: #f7f9fc;
      margin-bottom: 10px;
      padding: 12px;
      border-radius: 8px;
      display: flex; justify-content: space-between;
      align-items: center;
      border-left: 5px solid #2e86de;
    }
    .deleteBtn {
      background: #e74c3c;
      color: white; border: none;
      padding: 6px 10px; border-radius: 5px;
      cursor: pointer;
    }
    .deleteBtn:hover { background: #c0392b; }
  </style>
</head>
<body>
<main>
  <h1>Gestión de Stock</h1>

  <label for="barcode">Código de Barras:</label>
  <input type="text" id="barcode" placeholder="Escanéalo o escríbelo" />

  <div id="productNameContainer">
    <label for="productName">Nombre del Producto:</label>
    <input type="text" id="productName" placeholder="Nombre del producto" />
  </div>

  <label for="quantity">Cantidad:</label>
  <input type="number" id="quantity" min="1" value="1" />

  <button id="addBtn">Agregar al Stock</button>

  <div id="scannerControls">
    <button id="startScan">Escanear Código</button>
    <button id="stopScan">Detener Escáner</button>
  </div>
  <div id="reader"></div>

  <h2>Productos en Stock</h2>
  <ul id="stockList"></ul>
</main>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const barcodeInput = document.getElementById('barcode');
  const productNameInput = document.getElementById('productName');
  const quantityInput = document.getElementById('quantity');
  const addBtn = document.getElementById('addBtn');
  const stockList = document.getElementById('stockList');
  const startScanBtn = document.getElementById('startScan');
  const stopScanBtn = document.getElementById('stopScan');
  const readerDiv = document.getElementById('reader');

  let html5QrcodeScanner;
  let stock = JSON.parse(localStorage.getItem('stock')) || {};

  function saveStock() {
    localStorage.setItem('stock', JSON.stringify(stock));
  }

  function updateStockList() {
    stockList.innerHTML = '';
    for (const code in stock) {
      const item = stock[code];
      const li = document.createElement('li');
      li.innerHTML = `
        <div>
          <strong>${item.name}</strong><br />
          Código: ${code} | Cantidad: ${item.qty}
        </div>
        <button class="deleteBtn" data-code="${code}">Eliminar</button>`;
      stockList.appendChild(li);
    }
  }

  addBtn.addEventListener('click', () => {
    const code = barcodeInput.value.trim();
    const name = productNameInput.value.trim();
    const qty = parseInt(quantityInput.value);

    if (!code || !name || qty <= 0 || isNaN(qty)) {
      alert("Completa todos los campos correctamente.");
      return;
    }

    if (stock[code]) {
      stock[code].qty += qty;
    } else {
      stock[code] = { name, qty };
    }

    saveStock();
    updateStockList();

    barcodeInput.value = '';
    productNameInput.value = '';
    quantityInput.value = 1;
  });

  stockList.addEventListener('click', (e) => {
    if (e.target.classList.contains('deleteBtn')) {
      const code = e.target.dataset.code;
      if (confirm(`¿Eliminar el producto "${stock[code].name}"?`)) {
        delete stock[code];
        saveStock();
        updateStockList();
      }
    }
  });

  startScanBtn.addEventListener('click', () => {
    readerDiv.style.display = 'block';
    startScanBtn.style.display = 'none';
    stopScanBtn.style.display = 'inline-block';

    html5QrcodeScanner = new Html5Qrcode("reader");
    html5QrcodeScanner.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      (decodedText) => {
        barcodeInput.value = decodedText;
        html5QrcodeScanner.stop();
        readerDiv.style.display = 'none';
        stopScanBtn.style.display = 'none';
        startScanBtn.style.display = 'inline-block';
        productNameInput.focus();
      },
      (errorMessage) => {}
    ).catch(err => {
      alert("Error al iniciar la cámara: " + err);
      readerDiv.style.display = 'none';
      stopScanBtn.style.display = 'none';
      startScanBtn.style.display = 'inline-block';
    });
  });

  stopScanBtn.addEventListener('click', () => {
    if (html5QrcodeScanner) html5QrcodeScanner.stop();
    readerDiv.style.display = 'none';
    stopScanBtn.style.display = 'none';
    startScanBtn.style.display = 'inline-block';
  });

  updateStockList();
</script>
</body>
</html>
